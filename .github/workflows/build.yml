name: Build RF-Client (Windows | Any CPU)

on:
  push:
    branches: [ "**" ]
  pull_request:
    branches: [ "master" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: âš™ï¸ Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: ğŸ”§ Restore NuGet packages
        run: nuget restore RA2Client.sln

      - name: ğŸ—ï¸ Build Solution (Release | Any CPU)
        run: |
          Write-Host "ğŸš€ Building solution..."
          msbuild RA2Client.sln /p:Configuration=Release /p:Platform="Any CPU" /m /t:Build /v:detailed
        shell: pwsh

      - name: ğŸ“¦ Collect all output files
        run: |
          # åˆ›å»ºå‘å¸ƒç›®å½•
          mkdir release-package

          # RA2Client é¡¹ç›®çš„å®é™…è¾“å‡ºè·¯å¾„ï¼ˆæ ¹æ® .csproj é…ç½®ï¼‰
          $ra2clientOutputPath = "RA2Client\Bin\Resources\Binaries"
          
          if (Test-Path $ra2clientOutputPath) {
            Write-Host "âœ… Copying RA2Client files from: $ra2clientOutputPath"
            Copy-Item "$ra2clientOutputPath\*" -Destination release-package -Recurse -Force
            
            # æ£€æŸ¥æ˜¯å¦å¤åˆ¶äº†å…³é”®æ–‡ä»¶
            $ra2clientExe = "release-package\RA2Client.exe"
            if (Test-Path $ra2clientExe) {
              Write-Host "âœ… RA2Client.exe successfully copied!"
            } else {
              Write-Warning "âš ï¸ RA2Client.exe not found in output"
            }
          } else {
            Write-Warning "âš ï¸ RA2Client output path does not exist: $ra2clientOutputPath"
            
            # å°è¯•æ ‡å‡†è¾“å‡ºè·¯å¾„ä½œä¸ºå¤‡é€‰
            $standardPath = "RA2Client\bin\Release"
            if (Test-Path $standardPath) {
              Write-Host "âœ… Found RA2Client in standard path: $standardPath"
              Copy-Item "$standardPath\*" -Destination release-package -Recurse -Force
            }
          }

          # æ”¶é›†å…¶ä»–é¡¹ç›®çš„è¾“å‡ºï¼ˆå¯èƒ½ä½¿ç”¨æ ‡å‡†è·¯å¾„ï¼‰
          $projects = @(
            "ClientCore",
            "ClientGUI",
            "DTAConfig",
            "Localization",
            "Rampastring.XNAUI",
            "ClientUpdater",
            "RandomMapGenerator",
            "Reunion",
            "Rampastring.Tools"
          )

          foreach ($proj in $projects) {
            # æ£€æŸ¥æ ‡å‡†è¾“å‡ºè·¯å¾„
            $standardPath = "$proj\bin\Release"
            if (Test-Path $standardPath) {
              Write-Host "âœ… Copying from: $proj"
              Copy-Item "$standardPath\*" -Destination release-package -Recurse -Force
            } else {
              Write-Warning "âš ï¸ Standard output path not found for ${proj}"
              
              # æ£€æŸ¥å¯èƒ½çš„å…¶ä»–è¾“å‡ºè·¯å¾„ï¼ˆå¦‚æœæœ‰ç±»ä¼¼çš„è‡ªå®šä¹‰é…ç½®ï¼‰
              $altPath = "$proj\Bin\Resources\Binaries"
              if (Test-Path $altPath) {
                Write-Host "âœ… Found alternative output path for ${proj}: ${altPath}"
                Copy-Item "$altPath\*" -Destination release-package -Recurse -Force
              }
            }
          }

          $fileCount = (Get-ChildItem release-package -Recurse | Measure-Object).Count
          Write-Host "ğŸ“¦ Total files collected: $fileCount"
        shell: pwsh

      - name: ğŸ“¤ Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: RF-Client-Windows-${{ github.sha }}
          path: release-package/
          retention-days: 7
