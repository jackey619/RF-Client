name: Build RF-Client (Windows | Any CPU) - Debug

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: âš™ï¸ Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: ğŸ”§ Restore NuGet packages
        run: nuget restore RA2Client.sln

      - name: ğŸ—ï¸ Build Solution (Release | Any CPU)
        run: |
          Write-Host "ğŸš€ Building solution..."
          msbuild RA2Client.sln /p:Configuration=Release /p:Platform="Any CPU" /m /t:Build /v:detailed
        shell: pwsh

      - name: ğŸ•µï¸ Debug - Find all built files
        run: |
          Write-Host "ğŸ” Searching for all .exe and .dll files in workspace..."
          
          # æœç´¢æ‰€æœ‰ exe å’Œ dll æ–‡ä»¶
          $allExes = Get-ChildItem -Path . -Recurse -Include *.exe
          $allDlls = Get-ChildItem -Path . -Recurse -Include *.dll
          
          Write-Host "=== Found .exe files ==="
          foreach ($exe in $allExes) {
            Write-Host "  $($exe.FullName) (Size: $($exe.Length) bytes)"
          }
          
          Write-Host "`n=== Found .dll files ==="
          foreach ($dll in $allDlls) {
            Write-Host "  $($dll.FullName) (Size: $($dll.Length) bytes)"
          }
          
          # æ£€æŸ¥å¸¸è§çš„è¾“å‡ºç›®å½•
          Write-Host "`n=== Checking common output paths ==="
          $commonPaths = @(
            "RA2Client\bin\Release",
            "RA2Client\Bin\Resources\Binaries",
            "ClientCore\bin\Release",
            "ClientCore\Bin\Resources\Binaries",
            "ClientGUI\bin\Release",
            "ClientGUI\Bin\Resources\Binaries",
            "Bin",
            "Bin\Resources\Binaries"
          )
          
          foreach ($path in $commonPaths) {
            if (Test-Path $path) {
              Write-Host "âœ… $path exists"
              $items = Get-ChildItem $path -Recurse
              foreach ($item in $items) {
                Write-Host "  - $($item.Name) ($($item.Length) bytes)"
              }
            } else {
              Write-Host "âŒ $path does not exist"
            }
          }
        shell: pwsh

      - name: ğŸ“¦ Collect all output files (Updated)
        run: |
          # åˆ›å»ºå‘å¸ƒç›®å½•
          mkdir release-package -Force

          # æœç´¢æ‰€æœ‰æ„å»ºè¾“å‡ºæ–‡ä»¶
          $allBuiltFiles = Get-ChildItem -Path . -Recurse | Where-Object { 
            ($_.Extension -eq '.exe' -or $_.Extension -eq '.dll') -and 
            $_.FullName -notlike '*obj*' -and
            $_.FullName -notlike '*packages*'
          }

          Write-Host "ğŸ“¦ Found $($allBuiltFiles.Count) built executable files"

          foreach ($file in $allBuiltFiles) {
            $relativePath = Resolve-Path -Path $file.Directory -Relative
            $relativePath = $relativePath.TrimStart('.')
            
            $destDir = Join-Path "release-package" $relativePath
            New-Item -ItemType Directory -Path $destDir -Force | Out-Null
            
            $destFile = Join-Path $destDir $file.Name
            Copy-Item $file.FullName -Destination $destFile -Force
            Write-Host "âœ… Copied: $($file.Name) -> $destFile"
          }

          # æ£€æŸ¥æ˜¯å¦æœ‰ RA2Client.exe
          $ra2clientExe = Get-ChildItem -Path . -Recurse -Filter "RA2Client.exe" -ErrorAction SilentlyContinue
          if ($ra2clientExe) {
            Write-Host "âœ… RA2Client.exe found at: $($ra2clientExe.FullName)"
            # ç¡®ä¿ä¸»ç¨‹åºä¹Ÿè¢«å¤åˆ¶åˆ°æ ¹ç›®å½•
            Copy-Item $ra2clientExe.FullName -Destination "release-package\RA2Client.exe" -Force
          } else {
            Write-Warning "âš ï¸ RA2Client.exe not found anywhere in the workspace!"
          }

          $fileCount = (Get-ChildItem release-package -Recurse -File | Measure-Object).Count
          Write-Host "ğŸ“¦ Final count in release-package: $fileCount files"
        shell: pwsh

      - name: ğŸ“¤ Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: RF-Client-Windows-debug-${{ github.sha }}
          path: release-package/
          retention-days: 7
