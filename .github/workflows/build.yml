name: Build RF-Client (Windows | Any CPU)

on:
  push:
    branches: [ "**" ]
  pull_request:
    branches: [ "master" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: âš™ï¸ Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: ğŸ”§ Restore NuGet packages
        run: nuget restore RA2Client.sln

      - name: ğŸ—ï¸ Build Solution (Release | Any CPU)
        run: |
          $errorActionPreference = "Stop"
          msbuild RA2Client.sln `
            /p:Configuration=Release `
            /p:Platform="Any CPU" `
            /v:minimal `
            /m
          if ($LASTEXITCODE -ne 0) {
            Write-Error "MSBuild failed!"
            exit $LASTEXITCODE
          }
        shell: pwsh

      - name: ğŸ“¦ Collect all output files
        run: |
          $projects = @(
            "RA2Client",
            "ClientCore",
            "ClientGUI",
            "DTAConfig",
            "Localization",
            "Rampastring.XNAUI",
            "ClientUpdater",
            "RandomMapGenerator",
            "Reunion",
            "Rampastring.Tools"
          )

          mkdir release-package

          foreach ($proj in $projects) {
            $srcPath = "${{ github.workspace }}\$proj\bin\Release"
            if (Test-Path $srcPath) {
              Write-Host "âœ… Copying from $proj\bin\Release"
              Copy-Item "$srcPath\*" -Destination release-package -Recurse -Force
            } else {
              Write-Warning "âš ï¸  Output not found: $srcPath"
            }
          }

          # éªŒè¯æ˜¯å¦æ”¶é›†åˆ°å…³é”®æ–‡ä»¶
          $ra2clientExe = "release-package\RA2Client.exe"
          if (!(Test-Path $ra2clientExe)) {
            Write-Error "âŒ RA2Client.exe not found! Build may have failed silently."
            exit 1
          }

          $fileCount = (Get-ChildItem release-package -Recurse | Measure-Object).Count
          Write-Host "ğŸ“¦ Total files collected: $fileCount"

        shell: pwsh

      - name: ğŸ“¤ Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: RF-Client-Windows-${{ github.sha }}
          path: release-package/
          retention-days: 7
