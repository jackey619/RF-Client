name: Build RF-Client (Windows | Any CPU)

on:
  push:
    branches: [ "**" ]
  pull_request:
    branches: [ "master" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: âš™ï¸ Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: ğŸ”§ Restore NuGet packages
        run: nuget restore RA2Client.sln

      - name: ğŸ—ï¸ Build Solution (Release | Any CPU)
        run: |
          $errorActionPreference = "Stop"
          
          # 1. å…ˆæ£€æŸ¥è§£å†³æ–¹æ¡ˆæ–‡ä»¶æ˜¯å¦å­˜åœ¨
          if (!(Test-Path "RA2Client.sln")) {
            Write-Error "Solution file not found!"
            exit 1
          }
          
          # 2. æ‰§è¡Œæ„å»ºå¹¶æ•è·è¯¦ç»†è¾“å‡º
          Write-Host "ğŸš€ Starting build process..."
          $msbuildResult = Start-Process -FilePath "msbuild" -ArgumentList @(
            "RA2Client.sln",
            "/p:Configuration=Release",
            "/p:Platform=`"Any CPU`"",
            "/v:detailed",
            "/m"
          ) -Wait -PassThru -NoNewWindow
          
          if ($msbuildResult.ExitCode -ne 0) {
            Write-Error "MSBuild failed with exit code: $($msbuildResult.ExitCode)"
            exit $msbuildResult.ExitCode
          }
          
          # 3. éªŒè¯æ˜¯å¦æœ‰è¾“å‡ºæ–‡ä»¶ç”Ÿæˆ
          $buildSuccess = $false
          $projects = @(
            "RA2Client",
            "ClientCore",
            "ClientGUI",
            "DTAConfig",
            "Localization",
            "Rampastring.XNAUI",
            "ClientUpdater",
            "RandomMapGenerator",
            "Reunion",
            "Rampastring.Tools"
          )
          
          foreach ($proj in $projects) {
            $outputDir = "$proj\bin\Release"
            if (Test-Path $outputDir) {
              $files = Get-ChildItem $outputDir -Recurse -File
              if ($files.Count -gt 0) {
                Write-Host "âœ… $proj : Found $($files.Count) output files in $outputDir"
                $buildSuccess = $true
              } else {
                Write-Warning "âš ï¸ $proj : Output directory exists but is empty: $outputDir"
              }
            } else {
              Write-Warning "âš ï¸ $proj : Output directory does not exist: $outputDir"
            }
          }
          
          if (-not $buildSuccess) {
            Write-Error "âŒ No projects generated any output files! Build likely failed silently."
            exit 1
          }
          
          Write-Host "âœ… Build verification successful!"
        shell: pwsh

      - name: ğŸ“¦ Collect all output files
        run: |
          $projects = @(
            "RA2Client",
            "ClientCore",
            "ClientGUI",
            "DTAConfig",
            "Localization",
            "Rampastring.XNAUI",
            "ClientUpdater",
            "RandomMapGenerator",
            "Reunion",
            "Rampastring.Tools"
          )

          mkdir release-package

          foreach ($proj in $projects) {
            $srcPath = "${{ github.workspace }}\$proj\bin\Release"
            if (Test-Path $srcPath) {
              Write-Host "âœ… Copying from $proj"
              Copy-Item "$srcPath\*" -Destination release-package -Recurse -Force
            } else {
              Write-Warning "âš ï¸ Output not found: $srcPath"
            }
          }

          # éªŒè¯æ˜¯å¦æ”¶é›†åˆ°å…³é”®æ–‡ä»¶
          $ra2clientExe = "release-package\RA2Client.exe"
          if (!(Test-Path $ra2clientExe)) {
            Write-Error "âŒ RA2Client.exe not found! Build may have failed silently."
            exit 1
          }

          $fileCount = (Get-ChildItem release-package -Recurse | Measure-Object).Count
          Write-Host "ğŸ“¦ Total files collected: $fileCount"
        shell: pwsh

      - name: ğŸ“¤ Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: RF-Client-Windows-${{ github.sha }}
          path: release-package/
          retention-days: 7
